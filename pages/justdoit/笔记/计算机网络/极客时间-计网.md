# 各层的连接设备

## 物理层

> 转发器、集线器、HUB

- 集线器是广播的，不管某个接口是否需要，所有的比特都会被发送出去，然后让主机来判断是不是需要

## 数据链路层

> 网桥、桥接器、交换器

- 交换机拥有转发表，可以学习每个接口的主机的MAC地址

## 网络层

> 路由器

## 运输层

> 网关，又是路由器也被成为网关。路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的IP地址都和局域网的IP地址相同的网段，每只手都是它握住的那个局域网的网关

- MAC地址是一个局域网内才有效的地址。因而，MAC地址只要过网关，就必定会改变，因为已经换了局域网。两者主要的区别在于IP地址是否改变。不改变IP地址的网关，我们称为**转发网关；**改变IP地址的网关，我们称为**NAT网关**

# TCP

## TCP包头格式

![tcp-header](.\tcp-header.jpg)

- 序号解决乱序问题，序号对于一方来说是连续的（如A的序号，在B看来应该是连续的，但是A与B往返发送信息的序号不是连续的）
- 确认序号是对序号的确认
- 状态位：SYN是发起一个连接，ACK是回复，RST是重新连接，FIN是结束连接等。TCP是面向连接的，因而双方要维护连接的状态，这些带状态位的包的发送，会引起双方的状态变更
- 窗口：负责流量控制、拥塞避免

## 三次握手

> TCP的连接建立，我们常常称为三次握手，也常称为“请求->应答->应答之应答”的三个回合

![tcp-connect](.\tcp-connect.jpg)

- 三次握手，确保了双方在自己的角度上的**有来有回**，同时协商好了序号问题
- TCP每个连接的起始序号是不一样的，其随时间变化，可以看做是一个32位的计数器，当计数器重新开始循环时，至少需要4小时。之前的数据包已经不存活了

- 为什么需要三次握手？避免客户端重复发送的的建立连接请求后续到达而服务端误认为这是正常请求

## 四次挥手

> TCP的连接断开，常常称为四次挥手

![tcp-disconnect](.\tcp-disconnect.jpg)

- **MSL**是**Maximum Segment Lifetime**，**报文最大生存时间**，它是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃
- 客户端等待`2MSL`以确保服务端收到客户端的最后一次应答，以及等待服务端的所有报文失效

## 可靠交付

- 为了保证不丢包，对于发送的包都要进行应答，但是这个应答也不是一个一个来的，而是会应答某个之前的ID，表示都收到了，这种模式称为**累计确认**或者**累计应答**（**cumulative acknowledgment**）
- 丢包问题解决
  - 超时重传
  - SACK（**Selective Acknowledgment** ）

## 顺序问题

## 流量控制

> 对另一端而言

## 拥塞避免

> 对于整个网络而言

# Socket

# HTTP

- 目前使用的HTTP协议大部分都是1.1。在1.1的协议里面，默认是开启了Keep-Alive的，这样建立的TCP连接，就可以在多次请求中复用

## 请求

### 报文结构

- 请求行：方法 URL 版本
- 首部：字段名 字段值
- 实体