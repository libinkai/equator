# ACID

## Atomicity

> atomicity 原子性，事务中的操作要么全部成功，要么全部失败

- 如果是只读事务，保持原子性很简单：如果发生错误，要么重试要么返回错误代码；如果是非只读事务，必须保护系统中并发用户访问受影响的部分数据
- 

## Consistency

> consistency 一致性，事务开启之前与之后，数据库的完整性约束没有被破坏

## Isolation

> isolation 隔离性，一个事务提交之前对其它事务不可见

## Durability

> durability 持久性，一旦事务提交，其结果就是永久性的（持久性不是高可用性）

- `InnoDB引擎`默认隔离级别为RR，完全满足ACID特性
- **I由锁实现，ACD均由日志实现**

## 事务分类

### 扁平事务

- 由begin work开始，commit work 或者rollback work结束，二者之间操作为原子性

### 带有保存点的扁平事务

- 回滚到事务中的某一个点而不是开始

### 链事务

- 提交事务操作和开始事务操作合并为一个原子性操作，意味着下一个事务将看到上一个事务的结果，就好像在一个事务中进行的一样

### 嵌套事务

> 原生MYSQL并不支持

- 并行事务

- 事务树

### 分布式事务

- XA事务

# 事务的实现

> redo log被称为重做日志，用来保证事务的原子性和持久性；undo log用来保证事务的一致性

- redo 恢复提交事务修改的页操作，通常是物理日志，记录页的物理操作（即相当于快照）
- undo 回滚到行记录的某个版本，通常是逻辑日志，根据每行记录进行记录
- 数据库运行时不需要读取redo日志，其是顺序写的；undo日志需要随机读写
- redo保持在重做日志中，undo保存在数据库内部的一个特殊段中，这个段被称为undo 段（undo segment），位于共享表空间内

## redo

> 由两部分组成：内存中的重做日志缓冲，其是易失的；重做日志文件，其是持久性的

### flush策略

`InnoDB`默认：每次将重做日志缓冲写入重做日志文件之后，`InnoDB引擎`都需要调用一次`fsync`操作，通过`innodb_flush_log_at_trx_commit`参数控制刷新策略

- 0，事务提交时不进行写入重做日志操作，而是由主线程完成。主线程每一秒会执行一次`fsync`
- 1（默认），事务提交时刷新一次（Force Log at Commit机制）
- 2，写入到文件系统的缓存中，OS宕机时会丢失部分数据

### 日志块

- 重做日志缓存、文件均为块形式（redo log block）

### 重做日志组

- 日志重做组（log group）包含多个重做日志文件

## undo

> 用于支持回滚与MVCC

- 回滚：做的是和之前相反的操作，insert对应delete，delete对应insert，update则执行一个相反的update
- MVCC：当读取一行时，若该行被其它事务占用，当前事务可以利用undo读取之前的行以此实现非锁定读取
- undo log会产生redo log，因为undo也需要持久化保护

### 类型

- insert undo log，因为insert只对事务本身可见，对其它事务不可见，故这种类型的undo log在事务提交之后直接删除，不需要purge
- update undo log，记录的是delete和update操作产生二点undo log，该log可能需要支持MVCC，所以不能在事务提交之后直接删除。（rollback时可以删除）
  - delete操作并不直接删除记录，只是将记录标记为已删除（delete flag标记为1），最终的删除在purge中完成

## binlog

> 用来进行POINT-IN-TIME（PIT）的恢复（基于时间点恢复）以及主从复制（Replication）环境的建立

- redo log 与 bin log都是记录数据库的操作日志
- redo log 是 `InnoDB引擎`层级的，bin log是MYSQL层级的
- **redo log 记录的是对于每个页的修改，bin log记录的SQL语句**

## purge

- delete与update操作可能并不直接删除原有数据，而是延迟到purge操作。purge用于最终完成delete与update操作

## group commit

> 当事务为非只读事务时，每次事务提交都需要进行一次`fsync`操作。group commit允许调用一次`fsync`可以刷新多个事务日志到磁盘

# 事务控制语句

- start transaction | begin
- commit | commit work
- rollback | rollback work
- set transaction 设置事务隔离级别

# 隐式提交的SQL

- DDL语句
- 隐式修改MYSQL架构的操作
- 管理语句

# 事务的设计

- QPS 每秒请求数，TPS 每秒事务处理能力

# 隔离级别

> `InnoDB`在隔离级别RR下利用NKL实现了SQL标准的S级别

1. RU
2. RC
3. RR
4. S

## 命令

- 设置 `set [global|session] transaction isolation level`