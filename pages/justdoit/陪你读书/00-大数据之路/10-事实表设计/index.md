# 事实表设计

> 本文内容摘录于《大数据之路：阿里巴巴大数据实践》。

## 事实表基础

### 特性

- 事实表是数据仓库维度建模的核心，与业务紧密相连，通过获取描述业务过程的度量来表达业务过程，包含了引用的维度和与过程有关的度量。
- 相对维表来说，通常事实表比维表细长得多，数据行的增加速度也比维表快。
- 维度属性也可以存储到事实表中，作为“退化维度”。退化维度可以作为事实表的过滤条件，实现聚合操作。

### 设计原则

- 尽可能包含所有与业务过程相关的事实，以便满足分析需求。
- 只选择与业务过程相关的事实，不包含其它业务过程事实以面耦合过高，如订单下单业务过程的事实表，不应该包含支付金额这个属于支付过程的事实。
- 分解不可加性事实为可加的组件，如将订单的优惠率分解为订单原价与订单优惠金额。
- 选择维度与事实之前须明确粒度，粒度指的是表达业务的细节程度，每个维度和事实必须与所定义的粒度保持一致。
- 同一个事实表中不能包含多种不同粒度的事实，下图是一个bad case。

![image-20210803080642534](image-20210803080642534.png)

- 事实单位需要保持一致，对空值使用零值填充，适当使用退化维度提高事实表的易用性。

### 设计方法

- 选择业务过程以及确定事实表类型：通过分析业务过程，选择与需求有关的业务过程。如电商领域中选择“创建订单”或者同时选择“创建订单”与“买家付款”两个业务过程，其事实表类型会有所不同。
- 声明粒度：尽量选择最细级别的原子粒度以保事实表的灵活性，如父子订单的场景中，应该使用子订单粒度。
- 确定维度：确定粒度后也就确认了业务主键，可以进一步确认相关的维度组合以及字段，如粒度为子订单，相关维度有买家、卖家、商品等。
- 确定事实：确定业务过程的度量，如子订单事实表中，有子订单分摊金额、邮费、优惠等。
- 冗余维度：逆规范化便于查询等操作，如子订单事实表中冗余商品类别字段。

## 事务事实表

- 任何类型的事件都可以理解为一种事务，如交易过程中的创建订单、买家付款等事件。事务事实表针对这些过程构建，跟踪定义业务过程的个体行为作为数仓的原子明细数据。

### 设计过程

- 选择业务过程：电商交易中包含的过程主要有创建下单、付款、发货、收货，这四个业务过程是下游分析统计的重点。
- 确定粒度：确定事实表每一行数据表达的细节层次，电商交易中常见的父子订单就是两种粒度。用户下单后，对于同一个商店的商品会生成一个父订单，父订单记录了物流信息、商品优惠等数据；每个商品生成一个子订单，如果只有一个商品，则合并为一个订单。下单、付款、收货三个过程粒度一般为子订单粒度，而发货由于一个子订单可以拆成多个物流单发货，故粒度为物流单。
- 确定维度：确定买家、卖家、商品、商品类目等相关维度。
- 确定事实：事实表应该包含与其描述过程有关的所有事实。
- 冗余维度

### 单事务事实表

- 单事务事实表指的是对每一个业务过程设计一个事实表，优点是可以方便地对每个业务过程进行独立的分析。

### 多事务事实表

- 将不同的事实放到同一个事实表中，一般有两种处理方法：不同业务过程使用不同的事实字段存放，表会比较宽；不同的业务过程使用同一个事实字段存放，但是增加一个业务过程标记字段以示区分。
- 多事务事实表中业务过程的粒度需要尽可能保持一致，维度也尽量保持一致。

### 二者对比

![image-20210806094039267](image-20210806094039267.png)

### 设计准则

- 事实完整性，尽可能获取相关的信息。
- 事实一致性，明确存储一个事实以确保度量（口径）保持一致，避免使用方使用时需要自己加工导致数据不一致。
- 事实可加性，多存储可加性事实，利润率等比例型事实不便于使用方的聚合。

## 周期性快照事实表

### 特性

### 实例

### 注意事项

## 累积快照事实表

### 设计过程

### 特点

### 特殊处理

### 物理实现

## 三种事实表比较

## 无事实的事实表

## 聚集型事实表

### 聚集的基本原则

### 聚集的基本步骤

### 公共汇总层

